{include file="public/header" /}
<style type="text/css">
    .table-bordered>tbody>tr>td, .table-bordered>tbody>tr>th, .table-bordered>tfoot>tr>td, .table-bordered>tfoot>tr>th, .table-bordered>thead>tr>td, .table-bordered>thead>tr>th { border: 1px solid #e7e7e7; } #imgPicker div:first-child{ position: absolute;  width: 85px; height: 40px; } .goods_xc{ width: 100px; text-align:center; margin: 5px; display:inline-block; }
</style>

<body class="gray-bg">
<div class="wrapper wrapper-content animated">
    <div class="row">
        <div class="col-sm-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>网站配置</h5>
                    <div class="ibox-tools">
                        <div class="ibox-tools">
                            <a href="javascript:history.go(-1)"  title="返回">
                                <i class="fa fa-reply"> 返回</i>
                            </a>
                        </div>
                    </div>
                </div>
                <form  method="post" action="{:url('goodsHandle',['id'=>$id])}" id="btnForm">
                    <div class="ibox-content">
                        <!--<div class="clients-list">-->
                        <ul class="nav nav-tabs">
                            <li class="active"><a data-toggle="tab" href="#tab-basic"><i class="fa fa-book"></i> 通用信息</a></li>
                            <li ><a data-toggle="tab" href="#tab-img"><i class="fa fa-photo"></i> 商品相册</a></li>
                            <li ><a data-toggle="tab" href="#tab-spec"><i class="fa fa-briefcase"></i> 商品规格</a></li>
                            <li ><a data-toggle="tab" href="#tab-attr"><i class="fa fa-info"></i> 商品属性</a></li>
                            <li ><a data-toggle="tab" href="#tab-shipping"><i class="fa fa-truck"></i> 商品物流</a></li>
                        </ul>
                        <div class="tab-content" >
                            <!--通用信息    start-->
                            <div id="tab-basic" class="tab-pane active" >
                                <div class="hr-line-dashed"></div>
                                <div class="full-height-scroll">
                                    <div class="table-responsive">
                                        <table class="table table-bordered">
                                            <tbody>
                                            <tr>
                                                <td width="20%">商品名称：</td>
                                                <td>
                                                    <div class=" col-sm-4">
                                                        <input type="text" class="form-control" name="goods_name"  value="{$info.goods_name}" placeholder="商品名称">
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td width="20%">商品简介：</td>
                                                <td>
                                                    <div class=" col-sm-4">
                                                        <textarea name="goods_remark"  cols="50" rows="4" placeholder="商品简介">{$info.goods_remark}</textarea>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>商品分类：</td>
                                                <td>
                                                    <div class="col-md-3">
                                                        <select class="form-control m-b chosen-select " name="goods_category_id" id="pid" >
                                                            <option value="">请选择分类</option>
                                                            {foreach $p_list as $k=>$v}
                                                            <option value="{$v.id}" {eq name="info.goods_category_id" value="$v.id"}selected{/eq}>{:str_repeat('— ',$v.level*1)}{$v.cat_name}</option>
                                                            {/foreach}
                                                        </select>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>商品品牌：</td>
                                                <td>
                                                    <div class="col-md-2">
                                                        <select class="form-control m-b chosen-select" name="goods_brand_id" >
                                                            <option value="0">请选择品牌</option>
                                                            {foreach $brand as $k=>$v}
                                                            <option value="{$k}" {eq name="info.goods_brand_id" value="$k"}selected{/eq}>{$v}</option>
                                                            {/foreach}
                                                        </select>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td width="20%">商品图片：</td>
                                                <td>
                                                    <div class=" col-sm-4">
                                                        <a  class="btn btn-info" href="javascript:void(0);" style="float: left" uploader="original_img" data-url="{:url('Uploadify/jqUpload')}" data-path="goods" >+ 浏览文件
                                                            <input type="hidden" name="original_img" id="original_img" value="{$info.original_img}">
                                                        </a>
                                                        <img  id="original_img_img" style="float:left;margin-left: 120px;margin-top:10px; max-width: 300px;max-height: 300px"  onerror="this.src='/static/admin/images/no_img.jpg'" src="{$info.original_img}"/>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td width="20%">本店价：</td>
                                                <td>
                                                    <div class=" col-sm-2">
                                                        <input type="number" class="form-control" name="shop_price"  value="{$info.shop_price}" placeholder="本店价" onkeyup="this.value=this.value.replace(/[^\d.]/g,'')" onpaste="this.value=this.value.replace(/[^\d.]/g,'')" >
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td width="20%">市场价：</td>
                                                <td>
                                                    <div class=" col-sm-2">
                                                        <input type="number" class="form-control" name="market_price"  value="{$info.market_price}" placeholder="市场价" onkeyup="this.value=this.value.replace(/[^\d.]/g,'')" onpaste="this.value=this.value.replace(/[^\d.]/g,'')" >
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td width="20%">成本价：</td>
                                                <td>
                                                    <div class=" col-sm-2">
                                                        <input type="number" class="form-control" name="cost_price"  value="{$info.cost_price}" placeholder="成本价" onkeyup="this.value=this.value.replace(/[^\d.]/g,'')" onpaste="this.value=this.value.replace(/[^\d.]/g,'')" >
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td width="20%">重量：</td>
                                                <td>
                                                    <div class=" col-sm-2">
                                                        <input type="number" class="form-control" name="weight"  value="{$info.weight}" placeholder="重量" onkeyup="this.value=this.value.replace(/[^\d.]/g,'')" onpaste="this.value=this.value.replace(/[^\d.]/g,'')" >
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td width="20%">库存数量：</td>
                                                <td>
                                                    <div class=" col-sm-2">
                                                        <input type="number" class="form-control" name="store_count"  value="{$info.store_count}" placeholder="库存数量" onkeyup="this.value=this.value.replace(/[^\d.]/g,'')" onpaste="this.value=this.value.replace(/[^\d.]/g,'')" >
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>是否包邮：</td>
                                                <td>
                                                    <div class=" col-sm-4">
                                                        <div class="radio i-checks">
                                                            <input type="radio" name='is_free_shipping' value="1" {eq name="info.is_free_shipping" value="1"}checked{/eq} />是&nbsp;&nbsp;
                                                            <input type="radio" name='is_free_shipping' value="0" {if condition="$id gt 0 "}{eq name="info.is_free_shipping" value="0"}checked{/eq}{else /}checked{/if} />否
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td width="20%">详细描述：</td>
                                                <td>
                                                    <div class=" col-sm-8">
                                                        <!--<textarea class="span12 ckeditor" id="goods_content" name="goods_contenta" title="" style="height:800px;max-height:1000px;">{$info.goods_content}</textarea>-->
                                                        <div class="span12 ckeditor" id="goods_content" title="" style="height:800px;max-height:1000px;">{$info.goods_content}</div>
                                                    </div>
                                                    <input type="hidden" name="goods_content" value="">
                                                </td>
                                            </tr>

                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <!--通用信息    end-->

                            <!--商品相册    start-->
                            <div id="tab-img" class="tab-pane ">
                                <div class="hr-line-dashed"></div>
                                <div class="full-height-scroll">
                                    <div class="table-responsive">
                                        <table class="table  ">
                                            <tbody>
                                            <tr>
                                                <td  id="imgs" >
                                                    {empty name="images" value=""}
                                                    <div  id="rming">还没有图片,快去上传吧</div>
                                                    {else/}
                                                    {foreach $images as $v}
                                                    <div class="goods_xc">
                                                        <input type="hidden" value="{$v}" name="goods_images[]">
                                                        <a href="{$v}" target="_blank"><img width="100" height="100" src="{$v}"></a>
                                                        <span class="help-block m-b-none" style="margin-bottom: 1%"> <a href="javascript:void(0)" onclick="delImg(this,'{$v}',1)">删除</a></span>
                                                    </div>
                                                    {/foreach}
                                                    {/empty}

                                                </td>
                                            </tr>
                                            <tr >
                                                <td height="20px">
                                                        <div id="imgPicker"  style="float:left;position: absolute">添加图片</div>
                                                </td>
                                            </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <!--商品相册    end-->

                            <!--商品规格    start-->
                            <div id="tab-spec" class="tab-pane ">
                                <div class="hr-line-dashed"></div>
                                <div class="full-height-scroll">
                                    <div class="table-responsive">
                                        <table class="table " id="goodsSpec">
                                            <tbody>
                                            <tr>
                                                <td width="20%"><b>商品类型：</b></td>
                                                <td>
                                                    <div class="col-md-3">
                                                        <select class="form-control m-b" name="spec_type_id" id="gSid">
                                                            <option value="0">请选择商品类型</option>
                                                            {foreach $type_list as $k=>$v}
                                                            <option value="{$k}" {eq name="k" value="$info.spec_type_id"}selected{/eq}>{$v}</option>
                                                            {/foreach}
                                                        </select>
                                                    </div>
                                                </td>
                                            </tr>
                                            </tbody>
                                        </table>
                                        <div id="ajax_spec_data"><!-- ajax 返回规格--></div>
                                    </div>
                                </div>
                            </div>
                            <!--商品规格    end-->

                            <!--商品属性    start-->
                            <div id="tab-attr" class="tab-pane ">
                                <div class="hr-line-dashed"></div>
                                <div class="full-height-scroll">
                                    <div class="table-responsive">
                                        <table class="table table-bordered" id="goodsAttr">
                                            <tbody>
                                            <tr>
                                                <td width="20%">商品类型：</td>
                                                <td>
                                                    <div class="col-md-3">
                                                        <select class="form-control m-b" name="goods_type_id" id="gTid">
                                                            <option value="0">请选择商品类型</option>
                                                            {foreach $type_list as $k=>$v}
                                                            <option value="{$k}" {eq name="k" value="$info.goods_type_id"}selected{/eq}>{$v}</option>
                                                            {/foreach}
                                                        </select>
                                                    </div>
                                                </td>
                                            </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <!--商品属性    end-->

                            <!--商品物流    start-->
                            <div id="tab-shipping" class="tab-pane ">
                                商品物流
                                <div class="hr-line-dashed"></div>
                                <div class="full-height-scroll">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover">
                                            <tbody>
                                            <tr>
                                                <td class="client-avatar"><img alt="image" src="img/a2.jpg"> </td>
                                                <td><a data-toggle="tab" href="#contact-1" class="client-link">袁岳</a>
                                                </td>
                                                <td> 瑞安市海诚机械有限公司</td>
                                                <td class="contact-type"><i class="fa fa-envelope"> </i>
                                                </td>
                                                <td> gravida@qq.com</td>
                                                <td class="client-status"><span class="label label-primary">已验证</span>
                                                </td>
                                            </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <!--商品物流    end-->
                            <div class="form-group" >
                                <div class="col-sm-4 col-sm-offset-3">
                                    <a class="btn btn-primary" id="saveBtn"><i class="fa fa-save"></i> 保存</a>&nbsp;&nbsp;&nbsp;
                                    <a class="btn btn-danger" href="javascript:history.go(-1);"><i class="fa fa-close"></i> 返回</a>
                                </div>
                            </div>
                        </div>
                        <!--</div>-->
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
</div>
{include file="public/footer" /}

</body>
</html>
<!--以下是在线编辑器 代码 -->
<link rel="stylesheet" type="text/css" href="/static/admin/wangeditor/css/wangEditor.min.css">
<!--//防xss攻击js-->
<script src="/static/admin/js/xss.js"></script>

<!--引入jquery和wangEditor.js-->   <!--注意：javascript必须放在body最后，否则可能会出现问题-->
<script type="text/javascript" src="/static/admin/wangeditor/js/wangEditor.min.js"></script>

<!--这里引用jquery和wangEditor.js-->
<script type="text/javascript">
    var editor = new wangEditor('goods_content');
    // 配置自定义表情
    editor.config.emotions = {
        'default': {
            title: '常用',  // 组名称
            data: '/static/admin/wangeditor/js/emotions.data'
        },
        /* 第二组，id叫做'weibo'*/
        'weibo': { title: '微博表情', /* 组名称*/ data: [/* data 还可以直接赋值为一个表情包数组*/ {icon: 'http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/7a/shenshou_thumb.gif', value: '[草泥马]'}, { icon: 'http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/60/horse2_thumb.gif', value: '[神马]'}, { icon: 'http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/bc/fuyun_thumb.gif', value: '[浮云]'}, { icon: 'http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/c9/geili_thumb.gif', value: '[给力]'}, { icon: 'http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/f2/wg_thumb.gif', value: '[围观]'}, { icon: 'http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/70/vw_thumb.gif', value: '[威武]'}, { icon: 'http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/6e/panda_thumb.gif', value: '[熊猫]'}, { icon: 'http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/81/rabbit_thumb.gif', value: '[兔子]'}, { icon: 'http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/bc/otm_thumb.gif', value: '[奥特曼]'}, { icon: 'http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/15/j_thumb.gif', value: '[囧]'}, { icon: 'http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/89/hufen_thumb.gif', value: '[互粉]'}, { icon: 'http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/c4/liwu_thumb.gif', value: '[礼物]'}, { icon: 'http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/ac/smilea_thumb.gif', value: '[呵呵]'}, { icon: 'http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/0b/tootha_thumb.gif', value: '[哈哈]'}]}
    };
    editor.config.pasteFilter = false;// 粘贴过滤
    // 只粘贴纯文本
    // （注意，如果你在上面设置了 editor.config.pasteFilter = false 那么这个粘贴纯文本的设置将失效）
    editor.config.pasteText = false;

    // 上传图片
    editor.config.uploadImgUrl = "{:url('Uploadify/editUpload')}";
    editor.config.uploadImgFileName = 'myfile'// 配置上传文件名

    // 配置自定义参数
    editor.config.uploadParams = {
        path:'goods'
    };
    // 设置 headers
    editor.config.uploadHeaders = {
        'Accept' : 'text/x-json'
    };
    // 隐藏掉插入网络图片功能。该配置，只有在你正确配置了图片上传功能之后才可用。
    editor.config.hideLinkImg = false;
    editor.create();

</script>
<!--以上是在线编辑器 代码  end-->

<script type="text/javascript">
    /*表单提交*/
    $("#saveBtn").click(function() {
        //通用信息
        var goods_name = $("input[name=goods_name]").val();//商品名称
        var goods_remark = $("textarea[name=goods_remark]").val();//商品简介
        var goods_category_id = $("select[name=goods_category_id]").val();//商品分类
        var goods_brand_id = $("select[name=goods_brand_id]").val();//商品品牌
        var original_img = $("input[name=original_img]").val();//商品图片
        var shop_price = $("input[name=shop_price]").val();//本店价
        var market_price = $("input[name=market_price]").val();//市场价
        var cost_price = $("input[name=cost_price]").val();//成本价
        var weight = $("input[name=weight]").val();//重量
        var store_count = $("input[name=store_count]").val();//库存
        var goods_content = editor.$txt.html();//商品详细信息
        $("input[name=goods_content]").val(filterXSS(goods_content));//过滤xss攻击
        //商品属性
        var goods_type_id = $("select[name=goods_type_id]").val();//商品属性所属类型
        //商品相册 goods_images


        if (isEmpty('', goods_name, '商品名称不能为空') == false) {
            return false;
        }
        if (isEmpty('', goods_remark, '商品简介不能为空') == false) {
            return false;
        }
        if (isEmpty('', goods_category_id, '请选择商品分类') == false) {
            return false;
        }
        if (isEmpty('', goods_brand_id, '请选择商品品牌') == false) {
            return false;
        }
        if (isEmpty('', original_img, '请上传商品图片') == false) {
            return false;
        }
        if (isEmpty('', shop_price, '本店价不能为空') == false) {
            return false;
        }
        if (isEmpty('', market_price, '本市场价不能为空') == false) {
            return false;
        }
        if (isEmpty('', cost_price, '本成本价不能为空') == false) {
            return false;
        }
        if (isEmpty('', goods_content, '商品详细信息不能为空') == false) {
            return false;
        }
        ajaxFormBtn("{:url('goodsHandle',['id'=>$id])}", 'btnForm');
    });

    /*商品规格相关*/
    $(document).ready(function(){
        $("#gSid").change(function(){
            var goods_id = "{$id}";
            var spec_type_id = $(this).val();
            $.ajax({
               type:'POST',
                data:{goods_id:goods_id,spec_type_id:spec_type_id},
                url:"{:url('ajaxSpecValue')}",
                success:function(res){
                    $("#ajax_spec_data").empty().append(res);
                    ajaxGetSpecInput();	// 触发规格输入框

                },
            });
        });
        $("#gSid").trigger('change');
    });
    /*商品属性相关*/
    $(document).ready(function(){

        /*商品属性相关---异步获取商品属性*/
        $("#gTid").change(function(){
            var goods_id = "{$id}";
            var goods_type_id = $(this).val();
            $.post("{:url('ajaxAttrValue')}",{gid:goods_id,goods_type_id:goods_type_id},function(data){
                $("#goodsAttr tr:gt(0)").remove();
                $("#goodsAttr").append(data);
            });
        });
        $("#gTid").trigger('change'); //编辑时默认选中
    });

    //上传图片,初始化WebUploader
        var uploader = WebUploader.create({
            auto: true,// 选完文件后，是否自动上传。
            swf: '/static/admin/webupload/Uploader.swf',// swf文件路径
            server: "{:url('Uploadify/webUpload')}",// 文件接收服务端。
            duplicate :false,// 重复上传图片，true为可重复false为不可重复
            pick: '#imgPicker',// 选择文件的按钮。可选。

            accept: {
                title: 'Images',
                extensions: 'gif,jpg,jpeg,bmp,png',
                mimeTypes: 'image/jpg,image/jpeg,image/png'
            },
            'onUploadSuccess': function(myfile, data, response) {
                var htmls = '<div class="goods_xc "> ' +
                        '<input type="hidden" value="'+data._raw+'" name="goods_images[]">' +
                        '<a href="'+data._raw+'" target="_blank"><img width="100" height="100" src="'+data._raw+'"></a> ' +
                        '<span class="help-block m-b-none" style="margin-bottom: 1%"> <a href="javascript:void(0)" onclick="delImg(this,11,2)" data-path="'+data._raw+'">删除</a></span>' +
                        ' </div>';
//                var img_num = $(".goods_xc").length;//当前商品有几张图片
                $("#rming").remove();
                $("#imgs").append(htmls);
//                console.log(img_num);
            }
        });
    /**
     * 删除图片
     *@param path 上传路径
     *@param type 存在则为已经存在数据库
     */
    function delImg(obj,path,type){

        if(type == 2){ //未入库
           var p = $(obj).attr('data-path');
            $.post("{:url('uploadify/delImg')}",{path:p},function(){
            });
        }
        $(obj).parent().parent().remove();

    };
    var config = {
        '.chosen-select': {},
    }
    for (var selector in config) {
        $(selector).chosen(config[selector]);
    }
</script>